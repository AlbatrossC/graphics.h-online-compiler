<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Graphics.h Online Compiler</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        #header {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        #header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #cccccc;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-info {
            font-size: 11px;
            color: #858585;
            padding: 4px 10px;
            background: #2d2d30;
            border-radius: 3px;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: #2d2d30;
            border-radius: 4px;
            color: #858585;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #858585;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected .status-dot {
            background: #4ec9b0;
            animation: none;
        }

        .status-indicator.compiling .status-dot {
            background: #dcdcaa;
            animation: pulse 1s infinite;
        }

        .status-indicator.error .status-dot {
            background: #f48771;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        button {
            background: #0e639c;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover:not(:disabled) {
            background: #1177bb;
        }

        button:disabled {
            background: #3e3e42;
            color: #858585;
            cursor: not-allowed;
        }

        button.compile-btn {
            background: #16825d;
        }

        button.compile-btn:hover:not(:disabled) {
            background: #1a9870;
        }

        /* Main Layout */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #left-panel {
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            min-width: 300px;
            width: 50%;
        }

        #resizer {
            width: 4px;
            background: #2d2d30;
            cursor: col-resize;
            transition: background 0.2s;
        }

        #resizer:hover {
            background: #0e639c;
        }

        #right-panel {
            flex: 1;
            background: #000000;
            position: relative;
            min-width: 300px;
        }

        /* Editor Section */
        #editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor-toolbar {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-label {
            font-size: 12px;
            color: #cccccc;
            font-weight: 500;
        }

        #editor {
            flex: 1;
            overflow: hidden;
        }

        /* Progress Bar */
        #progress-container {
            display: none;
            background: #252526;
            border-top: 1px solid #3e3e42;
            padding: 12px 16px;
        }

        #progress-container.visible {
            display: block;
        }

        .progress-label {
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 8px;
        }

        .progress-bar-bg {
            height: 4px;
            background: #3e3e42;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #0e639c;
            width: 0%;
            transition: width 0.3s;
        }

        /* Error Panel */
        #error-panel {
            display: none;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            max-height: 200px;
            overflow: hidden;
            flex-direction: column;
        }

        #error-panel.visible {
            display: flex;
        }

        #error-header {
            background: #2d2d30;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }

        .error-title {
            font-size: 12px;
            color: #f48771;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .error-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            padding: 4px 8px;
            font-size: 11px;
            color: #cccccc;
            border: 1px solid #3e3e42;
        }

        .icon-btn:hover:not(:disabled) {
            background: #3e3e42;
            border-color: #505050;
        }

        #error-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #f48771;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Display Frame */
        #display-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #000000;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #loading-overlay.hidden {
            display: none;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #3e3e42;
            border-top-color: #0e639c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #cccccc;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 12px;
            color: #858585;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text" id="loading-text">Initializing session...</div>
        <div class="loading-subtext" id="loading-subtext">Starting backend services</div>
    </div>

    <!-- Header -->
    <div id="header">
        <h1>
            Windows Graphics.h Online Compiler
            <span class="session-info" id="session-id">Connecting...</span>
        </h1>
        <div class="header-controls">
            <div class="status-indicator" id="status-indicator">
                <span class="status-dot"></span>
                <span id="status-text">Disconnected</span>
            </div>
            <button id="compile-btn" class="compile-btn" onclick="runCode()" disabled>
                <span>▶</span> Compile & Run
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-container">
        <!-- Left Panel -->
        <div id="left-panel">
            <div id="editor-section">
                <div id="editor-toolbar">
                    <span class="toolbar-label">source.cpp</span>
                    <span class="toolbar-label" style="color: #858585; font-size: 11px;">Ctrl+Enter to run</span>
                </div>
                <div id="editor"></div>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container">
                <div class="progress-label" id="progress-label">Compiling...</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
            </div>

            <!-- Error Panel -->
            <div id="error-panel">
                <div id="error-header">
                    <div class="error-title">
                        <span>⚠</span> Compilation Error
                    </div>
                    <div class="error-actions">
                        <button class="icon-btn" onclick="copyError()" title="Copy error">Copy</button>
                        <button class="icon-btn" onclick="closeError()" title="Close">✕</button>
                    </div>
                </div>
                <div id="error-content"></div>
            </div>
        </div>

        <!-- Resizer -->
        <div id="resizer"></div>

        <!-- Right Panel -->
        <div id="right-panel">
            <iframe id="display-frame"></iframe>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let sessionId = null;
        let editor = null;
        let heartbeatInterval = null;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `#include <graphics.h>
#include <math.h>

int main() {
    int gd = DETECT, gm;
    initgraph(&gd, &gm, NULL);

    int x = 300, y = 200, r = 0;
    while (!kbhit()) {
        setcolor(1 + (r % 14));
        circle(x, y, r % 100);
        r++;
        delay(10);
    }
    
    closegraph();
    return 0;
}`,
                language: 'cpp',
                theme: 'vs-dark',
                fontSize: 14,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
                insertSpaces: true
            });

            // Add keyboard shortcut
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);
        });

        // Panel Resizing
        const leftPanel = document.getElementById('left-panel');
        const resizer = document.getElementById('resizer');
        const mainContainer = document.getElementById('main-container');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerRect = mainContainer.getBoundingClientRect();
            const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;

            if (newWidth >= 20 && newWidth <= 80) {
                leftPanel.style.width = newWidth + '%';
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Initialize Session
        window.addEventListener('load', async () => {
            try {
                updateLoading('Initializing session...', 'Connecting to server...');
                
                const res = await fetch('/api/init', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error || 'Initialization failed');
                }

                sessionId = data.sessionId;
                document.getElementById('session-id').textContent = `Session: ${data.nickname || sessionId.substring(0, 8)}`;
                
                if (data.streamReady) {
                    updateLoading('Connecting to display...', 'Loading graphics interface...');
                    startHeartbeat();
                    loadDisplayClient();
                } else {
                    throw new Error('Stream not ready');
                }
                
            } catch (e) {
                showFatalError('Initialization Failed', e.message);
            }
        });

        function updateLoading(text, subtext) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-subtext').textContent = subtext;
        }

        function loadDisplayClient() {
            const frame = document.getElementById('display-frame');
            const overlay = document.getElementById('loading-overlay');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const compileBtn = document.getElementById('compile-btn');

            const path = `/session/${sessionId}/stream/index.html`;
            const params = `?start=no&floating_menu=no&background_color=%23000000&clipboard=no`;
            
            frame.src = path + params;

            let loadTimeout = setTimeout(() => {
                console.warn('Display client load timeout, continuing anyway...');
                finishLoading();
            }, 10000);

            frame.onload = () => {
                clearTimeout(loadTimeout);
                setTimeout(finishLoading, 2000);
            };

            frame.onerror = () => {
                clearTimeout(loadTimeout);
                showFatalError('Display Connection Failed', 'Could not load graphics interface');
            };

            function finishLoading() {
                overlay.classList.add('hidden');
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Ready';
                compileBtn.disabled = false;
            }
        }

        async function runCode() {
            if (!sessionId || !editor) {
                showError('No active session');
                return;
            }
            
            const compileBtn = document.getElementById('compile-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const errorPanel = document.getElementById('error-panel');
            
            // Reset UI
            compileBtn.disabled = true;
            errorPanel.classList.remove('visible');
            progressContainer.classList.add('visible');
            progressBar.style.width = '0%';
            
            statusIndicator.classList.remove('connected', 'error');
            statusIndicator.classList.add('compiling');
            statusText.textContent = 'Compiling...';

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 100);

            try {
                const res = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        code: editor.getValue()
                    })
                });
                
                const data = await res.json();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (data.expired) {
                    alert('Session expired. Reloading page...');
                    location.reload();
                    return;
                }
                
                if (data.success) {
                    setTimeout(() => {
                        progressContainer.classList.remove('visible');
                        statusIndicator.classList.remove('compiling');
                        statusIndicator.classList.add('connected');
                        statusText.textContent = 'Running';
                    }, 500);
                } else {
                    progressContainer.classList.remove('visible');
                    statusIndicator.classList.remove('compiling');
                    statusIndicator.classList.add('error');
                    statusText.textContent = 'Compilation Failed';
                    showError(data.output || 'Unknown compilation error');
                }
                
            } catch (e) {
                clearInterval(progressInterval);
                progressContainer.classList.remove('visible');
                statusIndicator.classList.remove('compiling');
                statusIndicator.classList.add('error');
                statusText.textContent = 'Server Error';
                showError('Network error: ' + e.message);
            } finally {
                compileBtn.disabled = false;
            }
        }

        function showError(message) {
            const errorPanel = document.getElementById('error-panel');
            const errorContent = document.getElementById('error-content');
            errorContent.textContent = message;
            errorPanel.classList.add('visible');
        }

        function closeError() {
            document.getElementById('error-panel').classList.remove('visible');
        }

        function copyError() {
            const errorContent = document.getElementById('error-content').textContent;
            navigator.clipboard.writeText(errorContent).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function startHeartbeat() {
            heartbeatInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/heartbeat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId })
                    });
                    
                    const data = await res.json();
                    
                    if (data.expired || !data.alive) {
                        clearInterval(heartbeatInterval);
                        alert('Session expired. Reloading page...');
                        location.reload();
                    }
                } catch (e) {
                    console.error('Heartbeat failed:', e);
                }
            }, 30000);
        }

        function showFatalError(title, message) {
            const overlay = document.getElementById('loading-overlay');
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 500px; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px; color: #f48771;">⚠</div>
                    <h2 style="font-size: 20px; color: #f48771; margin-bottom: 12px;">${title}</h2>
                    <p style="color: #cccccc; line-height: 1.6; margin-bottom: 24px;">${message}</p>
                    <button onclick="location.reload()" style="padding: 10px 24px;">
                        Retry Connection
                    </button>
                </div>
            `;
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
        });
    </script>
</body>
</html>